## ë™ì‹œì„± ì œì–´ ë°©ì‹ì— ëŒ€í•œ ë¶„ì„

### â“ë™ì‹œì„± ì œì–´ë€?
ë‹¤ìˆ˜ì˜ ì“°ë ˆë“œ ë˜ëŠ” í”„ë¡œì„¸ìŠ¤ê°€ í•˜ë‚˜ì˜ ê³µìœ  ìì›ì— ì ‘ê·¼í•  ë•Œ ë°ì´í„°ì˜ ë¬´ê²°ì„±ì„ ë³´ì¥í•˜ê¸° ìœ„í•´ ì œì–´í•˜ëŠ” ê¸°ë²•ì´ë‹¤.

ì˜ˆë¥¼ ë“¤ì–´ ì—¬ëŸ¬ ì‚¬ìš©ìê°€ ë™ì‹œì— ê°™ì€ ìœ ì €ì˜ í¬ì¸íŠ¸ë¥¼ ì¶©ì „í•˜ê±°ë‚˜ ì‚¬ìš©í•  ê²½ìš° ì˜ë„í•˜ì§€ ì•Šì€ ê°’ì´ ì €ì¥ë  ìˆ˜ ìˆë‹¤. ì´ë¥¼ ë§‰ê¸° ìœ„í•´ ë™ì‹œì„± ì œì–´ê°€ í•„ìš”í•˜ë‹¤.

### â—ï¸ë™ì‹œì„± ì œì–´ì˜ ì¤‘ìš”ì„±
- **ë°ì´í„° ì •í•©ì„± ë³´ì¥**: ì¤‘ë³µ ì¶©ì „ ë˜ëŠ” í¬ì¸íŠ¸ ë¶€ì¡± ìƒíƒœì—ì„œ ì‚¬ìš© ì²˜ë¦¬ ë“± ì˜ëª»ëœ ê²°ê³¼ ë°©ì§€
- **ì›ìì„± í™•ë³´**: ì—¬ëŸ¬ ì“°ë ˆë“œê°€ ë™ì‹œì— ìˆ˜í–‰ë˜ëŠ” í™˜ê²½ì—ì„œ ì—°ì‚°ì„ í•˜ë‚˜ì˜ ë‹¨ìœ„ë¡œ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
- **ì„œë¹„ìŠ¤ ì‹ ë¢°ì„± í–¥ìƒ**: ì‚¬ìš©ì ê²½í—˜ ê°œì„  ë° ë²„ê·¸ ë°©ì§€

---
### ğŸ¤”  ì§€ê¸ˆ í”„ë¡œì íŠ¸ì—ì„œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ë™ì‹œì„± ë¬¸ì œëŠ” ë­˜ê¹Œ?

### ë°œìƒ ê°€ëŠ¥í•œ ë¬¸ì œ
1. **ë™ì¼ ìœ ì €ì—ê²Œ ë™ì‹œì— ì—¬ëŸ¬ ì¶©ì „ ìš”ì²­ì´ ë“¤ì–´ì˜¬ ê²½ìš°**
2. **ì¶©ì „ê³¼ ì‚¬ìš© ìš”ì²­ì´ ë™ì‹œì— ë“¤ì–´ì˜¬ ê²½ìš°**
3. **í¬ì¸íŠ¸ ì¶©ì „ ì¤‘ ì¡°íšŒë‚˜ ì‚¬ìš© ìš”ì²­ì´ ì¤‘ì²©ë˜ëŠ” ê²½ìš°**

ì˜ˆë¥¼ ë“¤ì–´ ì‚¬ìš©ì Aì—ê²Œ ë‘ ê°œì˜ ìš”ì²­ì´ ë™ì‹œì— ë“¤ì–´ì™€ `1000ì› ì¶©ì „`ê³¼ `500ì› ì‚¬ìš©`ì„ ê°ê° ìˆ˜í–‰í•œë‹¤ê³  ê°€ì •í–ˆì„ ë•Œ ì ì ˆí•œ ë½ì´ ì—†ìœ¼ë©´ ë‘˜ ì¤‘ í•˜ë‚˜ì˜ ì—°ì‚°ì´ ë®ì–´ì”Œì›Œì ¸ í¬ì¸íŠ¸ê°€ ì˜ëª» ë°˜ì˜ë  ìˆ˜ ìˆë‹¤.
ì´ëŸ¬í•œ ì‹œë‚˜ë¦¬ì˜¤ì—ì„œ ë°ì´í„°ë¥¼ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬í•˜ì§€ ì•Šìœ¼ë©´ `PointRepository`ì— ì €ì¥ëœ í¬ì¸íŠ¸ ì •ë³´ê°€ ê¼¬ì´ê²Œ ëœë‹¤.

---

### ğŸ”§ ìë°”ì˜ ë™ì‹œì„± ì œì–´ ë°©ë²•ì˜ ì¢…ë¥˜
### âœ… synchronized
- synchronizedëŠ” ìë°”ì—ì„œ ê°€ì¥ ê¸°ë³¸ì ì¸ ë™ê¸°í™” ë°©ë²•ì…ë‹ˆë‹¤. í•œ ë²ˆì— í•˜ë‚˜ì˜ ìŠ¤ë ˆë“œë§Œ íŠ¹ì • ë¸”ë¡ì´ë‚˜ ë©”ì„œë“œì— ì ‘ê·¼í•˜ë„ë¡ ì œí•œí•œë‹¤.
- ì¥ì  
  - ë¬¸ë²•ì´ ë‹¨ìˆœí•˜ê³  ì‚¬ìš©í•˜ê¸° ì‰½ë‹¤.
  - JVM ë ˆë²¨ì—ì„œ ìë™ìœ¼ë¡œ ë½ì„ ê´€ë¦¬í•˜ê¸° ë•Œë¬¸ì— ë¹„êµì  ì•ˆì „í•˜ë‹¤.

- ë‹¨ì 
  - ìë™ ë½ í•´ì²´ë¡œ ì¸í•´ ì„¸ë°€í•œ ì œì–´ê°€ ì–´ë µë‹¤.
  - ë½ì„ íšë“í•œ ìŠ¤ë ˆë“œê°€ ì‘ì—…ì„ ë§ˆì¹˜ê¸° ì „ê¹Œì§€ ë‹¤ë¥¸ ìŠ¤ë ˆë“œëŠ” ëŒ€ê¸°í•˜ë¯€ë¡œ ì„±ëŠ¥ ì €í•˜ê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤.
  - ë½ íšë“ ì‹¤íŒ¨ ì‹œ íƒ€ì„ì•„ì›ƒì„ ì„¤ì •í•  ìˆ˜ ì—†ë‹¤.

**ğŸ“Œ ê°„ë‹¨í•œ ë™ê¸°í™” ì²˜ë¦¬ì—ëŠ” ì í•©í•˜ì§€ë§Œ ì„¸ë°€í•œ ì œì–´ê°€ í•„ìš”í•œ ìƒí™©ì—ì„œëŠ” ì í•©í•˜ì§€ ì•Šì„ ìˆ˜ ìˆë‹¤!**

### âœ… ReentrantLock
- ReentrantLockì€ synchronizedì™€ ë™ì¼í•œ ê¸°ëŠ¥ì„ ì œê³µí•˜ë©´ì„œ ë” ì •êµí•˜ê²Œ ë½ì„ ì œì–´í•  ìˆ˜ ìˆë‹¤.
- ì¥ì 
  - lock()ê³¼ unlock()ì„ í†µí•´ ëª…ì‹œì ìœ¼ë¡œ ë½ì„ íšë“ ë° í•´ì œí•  ìˆ˜ ìˆë‹¤.
  - tryLock()ì„ í†µí•´ íƒ€ì„ì•„ì›ƒì„ ì„¤ì •í•˜ê±°ë‚˜ ë½ íšë“ ì‹¤íŒ¨ë¥¼ ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤.
  - ê³µì •ì„± ì„¤ì •ì´ ê°€ëŠ¥í•˜ì—¬ ë½ì„ ìš”ì²­í•œ ìˆœì„œëŒ€ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤.
- ë‹¨ì 
  - ë½ í•´ì œë¥¼ ë°˜ë“œì‹œ ê°œë°œìê°€ ëª…ì‹œì ìœ¼ë¡œ ì‘ì„±í•´ì•¼ í•˜ë¯€ë¡œ ëˆ„ë½ ì‹œ ë°ë“œë½ ìœ„í—˜ì´ ì¡´ì¬í•œë‹¤.
  - êµ¬í˜„ ë³µì¡ë„ê°€ synchronizedë³´ë‹¤ ë†’ë‹¤.

**ğŸ“Œ ì •êµí•œ ë™ê¸°í™”ê°€ í•„ìš”í•œ ê²½ìš° ìœ ìš©í•˜ë‹¤! ì´ë²ˆ ê³¼ì œì—ì„œë„ ì‚¬ìš©ì ë‹¨ìœ„ì˜ ë½ ì œì–´ë¥¼ ìœ„í•´ ì‚¬ìš©í–ˆë‹¤.**

### âœ…ConcurrentHashMap
- ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ ë™ì‹œì— ë°ì´í„°ë¥¼ ì½ê³  ì“¸ ìˆ˜ ìˆë„ë¡ ì„¤ê³„ëœ Mapì´ë‹¤. ë‚´ë¶€ì ìœ¼ë¡œ ì„¸ë¶„í™”ëœ ë½ì„ ì‚¬ìš©í•˜ê±°ë‚˜ CAS ì—°ì‚°ì„ í†µí•´ íš¨ìœ¨ì ì¸ ë™ì‹œì„± ì œì–´ë¥¼ ì œê³µí•œë‹¤.
- ì¥ì 
  - ëŒ€ë¶€ë¶„ì˜ ì—°ì‚°ì´ ë§¤ìš° ë¹ ë¥´ë©° ë½ì„ ì‚¬ìš©í•˜ì§€ ì•Šê±°ë‚˜ ìµœì†Œí•œìœ¼ë¡œ ì‚¬ìš©í•œë‹¤.
  - HashMapì„ ë©€í‹°ìŠ¤ë ˆë“œ í™˜ê²½ì—ì„œ ì•ˆì „í•˜ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.
- ë‹¨ì 
  - íŠ¸ëœì­ì…˜ê³¼ ê°™ì´ ì—¬ëŸ¬ ì—°ì‚°ì„ ë¬¶ì–´ ì²˜ë¦¬í•´ì•¼ í•˜ëŠ” ê²½ìš°ì—ëŠ” ë¶€ì í•©

**ğŸ“Œ ì´ë²ˆ í”„ë¡œì íŠ¸ì—ì„œëŠ” ì‚¬ìš©ì IDë¥¼ Keyë¡œ í•˜ê³  ReentrantLockì„ Valueë¡œ ê°€ì§€ëŠ” êµ¬ì¡°ë¥¼ í†µí•´ ì‚¬ìš©ìë³„ ë½ì„ ê´€ë¦¬í•˜ëŠ” ë° í™œìš©**

### âœ… Atomic í´ë˜ìŠ¤
- Atomic í´ë˜ìŠ¤ëŠ” CAS(Compare-And-Swap) ì—°ì‚°ì„ í™œìš©í•´ ë½ ì—†ì´ë„ ì›ìì ì¸ ì—°ì‚°ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì¤€ë‹¤.
- ì¥ì 
  - ë½ì„ ì‚¬ìš©í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ë§¤ìš° ë¹ ë¥´ë‹¤.
  - ë‹¨ì¼ ê°’ì˜ ì—°ì‚°ì— ë§¤ìš° ì í•©í•˜ë‹¤.
- ë‹¨ì 
  - ë³µì¡í•œ ì¡°ê±´ë¬¸ì´ë‚˜ ì—¬ëŸ¬ ë‹¨ê³„ì˜ ë¡œì§ì—ëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤.
  - ì§ê´€ì ì´ì§€ ì•Šë‹¤.

**ğŸ“Œ ë‹¨ìˆœí•œ ì¹´ìš´í„°ë‚˜ ìƒíƒœ í”Œë˜ê·¸ ì²˜ë¦¬ì— ì í•©í•˜ë‹¤. ì´ë²ˆ ê³¼ì œì˜ ì‚¬ìš©ìë³„ í¬ì¸íŠ¸ ë¡œì§ì—ëŠ” ì í•©í•˜ì§€ ì•ŠìŒ**

---

### âœ”ï¸ ìë°”ì˜ ë™ì‹œì„± ì œì–´ ë°©ë²• ì¤‘ ë‚´ê°€ ì‚¬ìš©í•œ ë°©ë²•
- `ReentrantLock`
- `ConcurrentHashMap`

> ê¸°ì¡´ì—ëŠ” `synchronized` í‚¤ì›Œë“œë„ í•¨ê»˜ ê³ ë ¤í–ˆìœ¼ë‚˜, ëª…ì‹œì ì¸ Lock ê°ì²´ì™€ì˜ ì¤‘ë³µ ì œì–´ë¡œ ì¸í•´ **ìµœì¢…ì ìœ¼ë¡œ ì œê±°**í•˜ì˜€ìŠµë‹ˆë‹¤.

### ê° ë°©ì‹ì˜ ë¹„êµ

| ë°©ì‹ | ì¥ì  | ë‹¨ì  |
|------|------|------|
| synchronized | ì‚¬ìš©ë²•ì´ ê°„ë‹¨í•˜ê³  ìë°” ë‚´ì¥ ê¸°ëŠ¥ | ì„¸ë°€í•œ ì œì–´ê°€ ì–´ë µê³ , ëª¨ë‹ˆí„° ê°ì²´ì— ì¢…ì†ë¨ |
| ReentrantLock | lock íšë“, í•´ì œ íƒ€ì´ë°ì„ ëª…ì‹œì ìœ¼ë¡œ ì œì–´ ê°€ëŠ¥ | ì½”ë“œê°€ ê¸¸ê³  ëª…ì‹œì ì¸ í•´ì œê°€ í•„ìš” |
| ConcurrentHashMap | ë³‘ë ¬ í™˜ê²½ì—ì„œ ì•ˆì „í•œ Map | ìì›ë³„ Lock ê´€ë¦¬ êµ¬ì¡°ë¥¼ ì§ì ‘ ì„¤ê³„í•´ì•¼ í•¨ |

---
### âœï¸ ì™œ ReentrantLock + ConcurrentHashMapì„ ì‚¬ìš©í–ˆëŠ”ê°€?
ë™ì¼ ìœ ì €ì— ëŒ€í•œ Lockì„ ì„¸ë°€í•˜ê²Œ ì œì–´í•˜ê¸° ìœ„í•´ `ConcurrentHashMap<Long, ReentrantLock>` êµ¬ì¡°ë¥¼ í™œìš©í•´ ì‚¬ìš©ì ë‹¨ìœ„ì˜ Lockì„ ê´€ë¦¬í–ˆìŠµë‹ˆë‹¤.

**ğŸ‘¤ ì‚¬ìš©ì ë‹¨ìœ„ ë½ ê´€ë¦¬ ë°©ì‹**
- ìœ ì € IDë¥¼ Keyë¡œ, í•´ë‹¹ ìœ ì € ì „ìš© ReentrantLockì„ Valueë¡œ ê°€ì§€ëŠ” êµ¬ì¡° 
- ì´ êµ¬ì¡°ë¥¼ í†µí•´ ë™ì¼ ìœ ì €ì— ëŒ€í•œ ìš”ì²­ë§Œ ë™ê¸°í™”
- ì„œë¡œ ë‹¤ë¥¸ ìœ ì €ì— ëŒ€í•œ ìš”ì²­ì€ ë™ì‹œì— ì²˜ë¦¬ë˜ë¯€ë¡œ ì„±ëŠ¥ ì €í•˜ë¥¼ ë°©ì§€í•  ìˆ˜ ìˆìŒ

**ConcurrentHashMapê³¼ ReentrantLockì„ í•¨ê»˜ ì‚¬ìš©í•˜ë©´ ìœ ì €ë³„ë¡œ ë½ì´ ë¶„ë¦¬ë˜ì–´ ì¶©ëŒì„ ì¤„ì´ê³  ë†’ì€ ë™ì‹œ ì²˜ë¦¬ ì„±ëŠ¥ì„ í™•ë³´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.**

```java
@Component
public class UserLockManager {
    private final ConcurrentHashMap<Long, ReentrantLock> lockMap = new ConcurrentHashMap<>();

    public ReentrantLock getLock(long userId) {
        return lockMap.computeIfAbsent(userId, id -> new ReentrantLock());
    }
}
```

---
### ì ìš©í•´ë³´ê¸°

**ë¦¬íŒ©í† ë§ ì „ (synchronized + ReentrantLock ì¤‘ë³µ ì‚¬ìš©)**
```java
@Override
public UserPoint charge(long id, long amount) {
    // 1. í•´ë‹¹ ìœ ì € ReentrantLockì„ ê°€ì ¸ì˜´
    ReentrantLock lock = userLockManager.getLock(id);

    // 2. lock ê°ì²´ë¥¼ ëª¨ë‹ˆí„°ë¡œ ì‚¬ìš©í•˜ëŠ” synchronized ë¸”ë¡
    synchronized (lock) {
        // 3. ëª…ì‹œì ìœ¼ë¡œ Lockì„ íšë“
        lock.lock();
        try {
            //í¬ì¸íŠ¸ ì¶©ì „
            UserPoint userPoint = pointRepository.selectById(id);
            UserPoint charged = userPoint.charge(amount);
            UserPoint saved = pointRepository.insertOrUpdate(charged);

            //ì¶©ì „ ë‚´ì—­ ì €ì¥
            pointHistoryRepository.insert(
                PointHistory.createChargeHistory(saved.id(), saved.point(), saved.updateMillis())
            );
            return saved;
        } finally {
            //4. lock í•´ì œ
            lock.unlock();
        }
    }
}
```
**âš ï¸ synchronized(lock)ê³¼ lock.lock()ì„ ë™ì‹œì— ì‚¬ìš©í•˜ëŠ” ê²ƒì€ ë¶ˆí•„ìš”í•œ ì¤‘ë³µ ì œì–´ì…ë‹ˆë‹¤.
ReentrantLock í•˜ë‚˜ë§Œìœ¼ë¡œë„ ì¶©ë¶„íˆ ì„ê³„ êµ¬ì—­ì„ ë³´í˜¸í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì´ ë°©ì‹ì€ ì˜¤íˆë ¤ ë½ ê²½í•© ì¦ê°€ ë° ì½”ë“œ ê°€ë…ì„± ì €í•˜ë¥¼ ìœ ë°œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.**

**ë¦¬íŒ©í† ë§ í›„**
```java
@Override
public UserPoint charge(long id, long amount) {
    // 1. í•´ë‹¹ ìœ ì € ReentrantLockì„ ê°€ì ¸ì˜´
    ReentrantLock lock = userLockManager.getLock(id);
    // 2. Lockì„ íšë“
    lock.lock();
    try {
        //í¬ì¸íŠ¸ ì¶©ì „
        UserPoint userPoint = pointRepository.selectById(id);
        UserPoint charged = userPoint.charge(amount);
        UserPoint saved = pointRepository.insertOrUpdate(charged);

        //ì¶©ì „ ë‚´ì—­ ì €ì¥
        pointHistoryRepository.insert(
                PointHistory.createChargeHistory(saved.id(), saved.point(), saved.updateMillis())
        );
        return saved;
    } finally {
        //3. lock í•´ì œ
        lock.unlock();
    }
}
```
**ğŸª„ ReentrantLockë§Œìœ¼ë¡œ ë™ì‹œì„± ì œì–´ê°€ ëª…í™•í•˜ê²Œ ê°€ëŠ¥í•´ì¡Œê³  ì½”ë“œë„ ê°„ê²°í•´ì¡ŒìŠµë‹ˆë‹¤.
ìœ ì € ë‹¨ìœ„ ë½ì€ ConcurrentHashMap<Long, ReentrantLock> êµ¬ì¡°ë¥¼ í†µí•´ ì•ˆì „í•˜ê²Œ ê´€ë¦¬ë©ë‹ˆë‹¤.**

### âŒ synchronizedëŠ” ì™œ ì œê±°í–ˆëŠ”ê°€?

ì²˜ìŒì—ëŠ” `synchronized(lock)`ê³¼ `lock.lock()`ì„ ê°™ì´ ì‚¬ìš©í–ˆìœ¼ë‚˜  **ì¤‘ë³µ ì œì–´**ë¡œ ì—¬ëŸ¬ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆì–´ì„œ ì œê±°í•˜ì˜€ìŠµë‹ˆë‹¤. 

- `ReentrantLock` ìì²´ê°€ ë½ ê¸°ëŠ¥ì„ ê°€ì§€ê³  ìˆìœ¼ë¯€ë¡œ `synchronized` ë¸”ë¡ìœ¼ë¡œ ë‹¤ì‹œ ê°ì‹¸ëŠ” ê²ƒì€ ë¶ˆí•„ìš”!
- ì˜¤íˆë ¤ ë¶ˆí•„ìš”í•œ ëª¨ë‹ˆí„° ê²½í•©ìœ¼ë¡œ ì„±ëŠ¥ì´ ì €í•˜ë  ìˆ˜ ìˆìŒ

ë”°ë¼ì„œ `ReentrantLock`ê³¼ ì‚¬ìš©ìë³„ ë½ ì €ì¥ì„ ìœ„í•œ  `ConcurrentHashMap`ì„ í•¨ê»˜ ì‚¬ìš©í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ë¦¬íŒ©í† ë§í•˜ì˜€ìŠµë‹ˆë‹¤.


---

### ê²°ë¡ 
- ì •ë°€í•œ ë½ ì œì–´ê°€ í•„ìš”í•œ í”„ë¡œì íŠ¸ ìƒí™©ì—ì„œëŠ” `ReentrantLock`ì´ ìœ ë¦¬í•˜ë‹¤.
- ìœ ì € ë‹¨ìœ„ë¡œ ë½ì„ ê´€ë¦¬í•´ì•¼ í•˜ë¯€ë¡œ `ConcurrentHashMap`ì´ í•¨ê»˜ ì‚¬ìš©ë˜ì—ˆë‹¤.
- `synchronized`ëŠ” ì¤‘ë³µ ì œì–´ë¡œ ì¸í•´ ìµœì¢…ì ìœ¼ë¡œ ì œê±°í•˜ì˜€ë‹¤.
- ë‹¨ìˆœí•œ synchronizedë³´ë‹¤ ì„¸ë°€í•œ ReentrantLock + ConcurrentHashMap ì¡°í•©ì„ í™œìš©í•´
  ë™ì¼ ì‚¬ìš©ì ë‹¨ìœ„ì˜ ë™ì‹œì„± ë¬¸ì œë¥¼ ì•ˆì „í•˜ê³  íš¨ìœ¨ì ìœ¼ë¡œ í•´ê²°í•  ìˆ˜ ìˆì—ˆë‹¤.
